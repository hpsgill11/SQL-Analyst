WITH base AS (
  SELECT 
  upper(substr(o.o_facility_name,1,3)) as Facility_Name,
      CASE 
        WHEN o.do_status = 110 THEN 'Released'
        WHEN o.do_status = 120 THEN 'Partially DC Allocated'
        WHEN o.do_status = 100 THEN 'DRAFT'
        ELSE NULL
      END AS do_status,
      oli.invn_type,
      o.order_type,
      CASE
        WHEN f.Region IS NOT NULL AND REGEXP_LIKE(f.Region, '^[0-9]')
          THEN REGEXP_SUBSTR(f.Region, '^[0-9]+') || ' DAY'
        ELSE f.Region
      END AS Region,

      f.zone AS Zone,
      
      
        sum (oli.order_qty - oli.ALLOCATED_QTY) as num_units,
            

      CASE
        WHEN oli.invn_type = 'E' AND ifm.pick_locn_assign_type = 'P09'            THEN 'Milton - Footwear'
        WHEN oli.invn_type = 'E' AND ic.PRODUCT_CLASS_ID = 172                    THEN 'Milton - Mats'
        WHEN oli.invn_type = 'E' AND ifm.pick_locn_assign_type = 'P06'            THEN 'Milton - Bags'
        WHEN oli.invn_type = 'E' AND ic.item_style LIKE 'LM%'                     THEN 'Milton - Mens'
        WHEN oli.invn_type = 'E' AND ic.item_style LIKE 'LW%'                     THEN 'Mississauga - Womens'
        WHEN oli.invn_type = 'E' AND ic.item_style LIKE 'LU%'                     THEN 'Mississauga - Accessories'
        WHEN ifm.pick_locn_assign_type = 'P09'                                    THEN 'Milton - Footwear'
        WHEN ic.PRODUCT_CLASS_ID = 172                                            THEN 'Milton - Mats'
        WHEN o.order_type IN ('ALLOC','REPLEN','SPECIAL') AND oli.invn_type = 'R' 
             AND ifm.pick_locn_assign_type IN ('P06','P05')                       THEN 'Milton - Accessories'
        WHEN o.order_type IN ('ALLOC','REPLEN','SPECIAL') AND oli.invn_type = 'R' 
             AND ifm.pick_locn_assign_type NOT IN ('P06','P05')                   THEN 'Milton - Apparel'
        WHEN oli.invn_type <> 'E'                                                 THEN 'Milton'
        ELSE NULL
      END AS Wave_Building,

      CASE  
        WHEN UPPER(o.mark_for) LIKE 'ALC%'       THEN SUBSTR(o.mark_for, -5)
        WHEN UPPER(o.mark_for) LIKE 'AAL%'       THEN SUBSTR(o.mark_for, 0, 3)
        WHEN UPPER(o.mark_for) LIKE 'CUSTOM%FO%' THEN 'CUSTOM FO'
        WHEN UPPER(o.mark_for) LIKE 'CUS%'       THEN SUBSTR(o.mark_for, 0, 6)
        WHEN UPPER(o.mark_for) LIKE 'SPE%'       THEN SUBSTR(o.mark_for, 0, 999)
        ELSE NULL 
      END AS Mark_for,

      CASE 
        WHEN o.order_type = 'INTERCOMPANY' AND (o.mark_for LIKE '%NSO%' OR f.Region = 'NSO') THEN 'NSO'
        WHEN o.order_type = 'INTERCOMPANY' AND o.mark_for LIKE '%CUSTOM%FO%'                THEN 'CUSTOM FO'
        WHEN o.order_type = 'INTERCOMPANY' AND o.mark_for LIKE '%STRAGGLER%'                THEN 'STRAGGLER'
        WHEN o.order_type = 'INTERCOMPANY' AND o.mark_for LIKE '%FULL PULL%'                THEN 'FULL PULL'
        WHEN o.order_type = 'INTERCOMPANY' AND o.mark_for LIKE '%BFMD%'                     THEN 'BFMD'

        WHEN o.order_type = 'DCTRANSFER' AND (o.mark_for LIKE '%NSO%' OR f.Region = 'NSO')  THEN 'NSO'
        WHEN o.order_type = 'DCTRANSFER' AND o.mark_for LIKE '%CUSTOM%FO%'                  THEN 'CUSTOM FO'
        WHEN o.order_type = 'DCTRANSFER' AND o.mark_for LIKE '%STRAGGLER%'                  THEN 'STRAGGLER'
        WHEN o.order_type = 'DCTRANSFER' AND o.mark_for LIKE '%FULL PULL%'                  THEN 'FULL PULL'
        WHEN o.order_type = 'DCTRANSFER' AND o.mark_for LIKE '%BFMD%'                       THEN 'BFMD'

        WHEN o.order_type = 'SPECIAL' AND (o.mark_for LIKE '%NSO%' OR f.Region = 'NSO')     THEN 'NSO'
        WHEN o.order_type = 'SPECIAL' AND o.mark_for LIKE '%CUSTOM%FO%'                     THEN 'CUSTOM FO'
        WHEN o.order_type = 'SPECIAL' AND o.mark_for LIKE '%STRAGGLER%'                     THEN 'STRAGGLER'
        WHEN o.order_type = 'SPECIAL' AND o.mark_for LIKE '%FULL PULL%'                     THEN 'FULL PULL'
        WHEN o.order_type = 'SPECIAL' AND o.mark_for LIKE '%BFMD%'                          THEN 'BFMD'
        
        WHEN o.order_type = 'ALLOC' AND (o.mark_for LIKE '%NSO%' OR f.Region = 'NSO')       THEN 'NSO' 
        WHEN o.order_type = 'ALLOC' AND o.mark_for LIKE '%CUSTOM%FO%'                       THEN 'CUSTOM FO'
        WHEN o.order_type = 'ALLOC' AND (o.mark_for LIKE '%STRAGGLER%' OR f.Region = 'NSO') THEN 'STRAGGLER' 
        WHEN o.order_type = 'ALLOC' AND (o.mark_for LIKE '%FULL PULL%' OR f.Region = 'NSO') THEN 'FULL PULL' 
        WHEN o.order_type = 'ALLOC' AND o.mark_for LIKE '%BFMD%'                            THEN 'BFMD'

        WHEN o.order_type = 'STRAT' AND (o.mark_for LIKE '%NSO%' OR f.Region = 'NSO')       THEN 'NSO'
        WHEN o.order_type = 'STRAT' AND o.mark_for LIKE '%CUSTOM%FO%'                       THEN 'CUSTOM FO'
        WHEN o.order_type = 'STRAT' AND (o.mark_for LIKE '%STRAGGLER%' OR f.Region = 'NSO') THEN 'STRAGGLER'
        WHEN o.order_type = 'STRAT' AND (o.mark_for LIKE '%FULL PULL%' OR f.Region = 'NSO') THEN 'FULL PULL'
        WHEN o.order_type = 'STRAT' AND o.mark_for LIKE '%BFMD%'                            THEN 'BFMD'

        WHEN o.order_type = 'REPLEN' AND (o.mark_for LIKE '%NSO%' OR f.Region = 'NSO')      THEN 'NSO'
        WHEN o.order_type = 'REPLEN' AND o.mark_for LIKE '%CUSTOM%FO%'                      THEN 'CUSTOM FO'
        WHEN o.order_type = 'REPLEN' AND o.mark_for LIKE '%STRAGGLER%'                      THEN 'STRAGGLER'
        WHEN o.order_type = 'REPLEN' AND o.mark_for LIKE '%FULL PULL%'                      THEN 'FULL PULL'
        WHEN o.order_type = 'REPLEN' AND o.mark_for LIKE '%BFMD%'                           THEN 'BFMD'

        WHEN o.order_type = 'WAREHOUSE' AND (o.mark_for LIKE '%NSO%' OR f.Region = 'NSO')   THEN 'NSO'
        WHEN o.order_type = 'WAREHOUSE' AND o.mark_for LIKE '%CUSTOM%FO%'                   THEN 'CUSTOM FO'
        WHEN o.order_type = 'WAREHOUSE' AND o.mark_for LIKE '%STRAGGLER%'                   THEN 'STRAGGLER'
        WHEN o.order_type = 'WAREHOUSE' AND o.mark_for LIKE '%FULL PULL%'                   THEN 'FULL PULL'
        WHEN o.order_type = 'WAREHOUSE' AND o.mark_for LIKE '%BFMD%'                        THEN 'BFMD'

        WHEN o.order_type = 'COMMUNITY' AND (o.mark_for LIKE '%NSO%' OR f.Region = 'NSO')   THEN 'NSO'
        WHEN o.order_type = 'COMMUNITY' AND o.mark_for LIKE '%CUSTOM%FO%'                   THEN 'CUSTOM FO'
        WHEN o.order_type = 'COMMUNITY' AND o.mark_for LIKE '%STRAGGLER%'                   THEN 'STRAGGLER'
        WHEN o.order_type = 'COMMUNITY' AND o.mark_for LIKE '%FULL PULL%'                   THEN 'FULL PULL'
        WHEN o.order_type = 'COMMUNITY' AND o.mark_for LIKE '%BFMD%'                        THEN 'BFMD'
        ELSE NULL
      END AS order_Category,

      COUNT(DISTINCT o.tc_order_id) AS num_orders,

TO_CHAR(
  CASE 
    WHEN o.order_type = 'ALLOC' THEN o.DELIVERY_END_DTTM
    ELSE o.created_dttm
  END,
  'YYYY/MM/DD'
) AS Oldest_Order_Date

  FROM 
      WM.orders o 
      JOIN WM.order_line_item oli ON o.order_id = oli.order_id
      JOIN WM.item_facility_mapping_wms ifm ON ifm.item_id = oli.item_id
      JOIN WM.do_status ds ON ds.order_status = o.do_status
      JOIN WM.item_cbo ic ON oli.item_name = ic.item_name 
    --  JOIN WM.wm_inventory wmi ON oli.item_id = wmi.ITEM_ID AND oli.invn_type = wmi.inventory_type
     -- JOIN WM.locn_hdr lh ON wmi.LOCATION_ID = lh.LOCN_ID
      JOIN WM.item_master im ON ic.item_id = im.item_id
      LEFT JOIN WM.facility f ON o.d_facility_id = f.facility_id
  WHERE 
      o.do_status IN ('110','120')
        AND oli.DO_DTL_STATUS <= 120
      AND o.is_original_order = '1'
    --  and o.order_type = 'STRAT'
  GROUP BY
    upper(substr(o.o_facility_name,1,3)) ,
      CASE 
        WHEN o.do_status = 110 THEN 'Released'
        WHEN o.do_status = 120 THEN 'Partially DC Allocated'
        WHEN o.do_status = 100 THEN 'DRAFT'
        ELSE NULL
      END,
      CASE WHEN o.order_type = 'ALLOC' THEN o.DELIVERY_END_DTTM
           ELSE o.created_dttm END,
      oli.invn_type,
      o.order_type,
      CASE
        WHEN f.Region IS NOT NULL AND REGEXP_LIKE(f.Region, '^[0-9]') 
          THEN REGEXP_SUBSTR(f.Region, '^[0-9]+') || ' DAY'
        ELSE f.Region
      END,
      f.zone,
      CASE  
        WHEN UPPER(o.mark_for) LIKE 'ALC%'       THEN SUBSTR(o.mark_for, -5)
        WHEN UPPER(o.mark_for) LIKE 'AAL%'       THEN SUBSTR(o.mark_for, 0, 3)
        WHEN UPPER(o.mark_for) LIKE 'CUSTOM%FO%' THEN 'CUSTOM FO'
        WHEN UPPER(o.mark_for) LIKE 'CUS%'       THEN SUBSTR(o.mark_for, 0, 6)
        WHEN UPPER(o.mark_for) LIKE 'SPE%'       THEN SUBSTR(o.mark_for, 0, 999)
        ELSE NULL 
      END,
      CASE
        WHEN oli.invn_type = 'E' AND ifm.pick_locn_assign_type = 'P09'            THEN 'Milton - Footwear'
        WHEN oli.invn_type = 'E' AND ic.PRODUCT_CLASS_ID = 172                    THEN 'Milton - Mats'
        WHEN oli.invn_type = 'E' AND ifm.pick_locn_assign_type = 'P06'            THEN 'Milton - Bags'
        WHEN oli.invn_type = 'E' AND ic.item_style LIKE 'LM%'                     THEN 'Milton - Mens'
        WHEN oli.invn_type = 'E' AND ic.item_style LIKE 'LW%'                     THEN 'Mississauga - Womens'
        WHEN oli.invn_type = 'E' AND ic.item_style LIKE 'LU%'                     THEN 'Mississauga - Accessories'
        WHEN ifm.pick_locn_assign_type = 'P09'                                    THEN 'Milton - Footwear'
        WHEN ic.PRODUCT_CLASS_ID = 172                                            THEN 'Milton - Mats'
        WHEN o.order_type IN ('ALLOC','REPLEN','SPECIAL') AND oli.invn_type = 'R' 
             AND ifm.pick_locn_assign_type IN ('P06','P05')                       THEN 'Milton - Accessories'
        WHEN o.order_type IN ('ALLOC','REPLEN','SPECIAL') AND oli.invn_type = 'R' 
             AND ifm.pick_locn_assign_type NOT IN ('P06','P05')                   THEN 'Milton - Apparel'
        WHEN oli.invn_type <> 'E'                                                 THEN 'Milton'
        ELSE NULL
      END,
      CASE 
        WHEN o.order_type = 'INTERCOMPANY' AND (o.mark_for LIKE '%NSO%' OR f.Region = 'NSO') THEN 'NSO'
        WHEN o.order_type = 'INTERCOMPANY' AND o.mark_for LIKE '%CUSTOM%FO%'                THEN 'CUSTOM FO'
        WHEN o.order_type = 'INTERCOMPANY' AND o.mark_for LIKE '%STRAGGLER%'                THEN 'STRAGGLER'
        WHEN o.order_type = 'INTERCOMPANY' AND o.mark_for LIKE '%FULL PULL%'                THEN 'FULL PULL'
        WHEN o.order_type = 'INTERCOMPANY' AND o.mark_for LIKE '%BFMD%'                     THEN 'BFMD'
        WHEN o.order_type = 'DCTRANSFER' AND (o.mark_for LIKE '%NSO%' OR f.Region = 'NSO')  THEN 'NSO'
        WHEN o.order_type = 'DCTRANSFER' AND o.mark_for LIKE '%CUSTOM%FO%'                  THEN 'CUSTOM FO'
        WHEN o.order_type = 'DCTRANSFER' AND o.mark_for LIKE '%STRAGGLER%'                  THEN 'STRAGGLER'
        WHEN o.order_type = 'DCTRANSFER' AND o.mark_for LIKE '%FULL PULL%'                  THEN 'FULL PULL'
        WHEN o.order_type = 'DCTRANSFER' AND o.mark_for LIKE '%BFMD%'                       THEN 'BFMD'
        WHEN o.order_type = 'SPECIAL' AND (o.mark_for LIKE '%NSO%' OR f.Region = 'NSO')     THEN 'NSO'
        WHEN o.order_type = 'SPECIAL' AND o.mark_for LIKE '%CUSTOM%FO%'                     THEN 'CUSTOM FO'
        WHEN o.order_type = 'SPECIAL' AND o.mark_for LIKE '%STRAGGLER%'                     THEN 'STRAGGLER'
        WHEN o.order_type = 'SPECIAL' AND o.mark_for LIKE '%FULL PULL%'                     THEN 'FULL PULL'
        WHEN o.order_type = 'SPECIAL' AND o.mark_for LIKE '%BFMD%'                          THEN 'BFMD'
        WHEN o.order_type = 'ALLOC' AND (o.mark_for LIKE '%NSO%' OR f.Region = 'NSO')       THEN 'NSO' 
        WHEN o.order_type = 'ALLOC' AND o.mark_for LIKE '%CUSTOM%FO%'                       THEN 'CUSTOM FO'
        WHEN o.order_type = 'ALLOC' AND (o.mark_for LIKE '%STRAGGLER%' OR f.Region = 'NSO') THEN 'STRAGGLER' 
        WHEN o.order_type = 'ALLOC' AND (o.mark_for LIKE '%FULL PULL%' OR f.Region = 'NSO') THEN 'FULL PULL' 
        WHEN o.order_type = 'ALLOC' AND o.mark_for LIKE '%BFMD%'                            THEN 'BFMD'
        WHEN o.order_type = 'STRAT' AND (o.mark_for LIKE '%NSO%' OR f.Region = 'NSO')       THEN 'NSO'
        WHEN o.order_type = 'STRAT' AND o.mark_for LIKE '%CUSTOM%FO%'                       THEN 'CUSTOM FO'
        WHEN o.order_type = 'STRAT' AND (o.mark_for LIKE '%STRAGGLER%' OR f.Region = 'NSO') THEN 'STRAGGLER'
        WHEN o.order_type = 'STRAT' AND (o.mark_for LIKE '%FULL PULL%' OR f.Region = 'NSO') THEN 'FULL PULL'
        WHEN o.order_type = 'STRAT' AND o.mark_for LIKE '%BFMD%'                            THEN 'BFMD'
        WHEN o.order_type = 'REPLEN' AND (o.mark_for LIKE '%NSO%' OR f.Region = 'NSO')      THEN 'NSO'
        WHEN o.order_type = 'REPLEN' AND o.mark_for LIKE '%CUSTOM%FO%'                      THEN 'CUSTOM FO'
        WHEN o.order_type = 'REPLEN' AND o.mark_for LIKE '%STRAGGLER%'                      THEN 'STRAGGLER'
        WHEN o.order_type = 'REPLEN' AND o.mark_for LIKE '%FULL PULL%'                      THEN 'FULL PULL'
        WHEN o.order_type = 'REPLEN' AND o.mark_for LIKE '%BFMD%'                           THEN 'BFMD'
        WHEN o.order_type = 'WAREHOUSE' AND (o.mark_for LIKE '%NSO%' OR f.Region = 'NSO')   THEN 'NSO'
        WHEN o.order_type = 'WAREHOUSE' AND o.mark_for LIKE '%CUSTOM%FO%'                   THEN 'CUSTOM FO'
        WHEN o.order_type = 'WAREHOUSE' AND o.mark_for LIKE '%STRAGGLER%'                   THEN 'STRAGGLER'
        WHEN o.order_type = 'WAREHOUSE' AND o.mark_for LIKE '%FULL PULL%'                   THEN 'FULL PULL'
        WHEN o.order_type = 'WAREHOUSE' AND o.mark_for LIKE '%BFMD%'                        THEN 'BFMD'
        WHEN o.order_type = 'COMMUNITY' AND (o.mark_for LIKE '%NSO%' OR f.Region = 'NSO')   THEN 'NSO'
        WHEN o.order_type = 'COMMUNITY' AND o.mark_for LIKE '%CUSTOM%FO%'                   THEN 'CUSTOM FO'
        WHEN o.order_type = 'COMMUNITY' AND o.mark_for LIKE '%STRAGGLER%'                   THEN 'STRAGGLER'
        WHEN o.order_type = 'COMMUNITY' AND o.mark_for LIKE '%FULL PULL%'                   THEN 'FULL PULL'
        WHEN o.order_type = 'COMMUNITY' AND o.mark_for LIKE '%BFMD%'                        THEN 'BFMD'
        ELSE NULL
      END
)
SELECT 
Facility_Name,
    order_type,
        do_status AS Order_Status,
            invn_type,
Oldest_Order_Date,
    order_Category,
        Mark_for,
    Wave_Building,
    Region,
    Zone,
    SUM(num_orders) AS Total_Orders,
    sum(num_units) as Total_Units
FROM base
GROUP BY
Facility_Name,
    Oldest_Order_Date,
    do_status,
    order_type,
    invn_type,
    Wave_Building,
    order_Category,
    Mark_for,
    Region,
    Zone
ORDER BY 
    do_status DESC, order_type;
