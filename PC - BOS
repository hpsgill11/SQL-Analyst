SELECT 
    do_status as Order_Status,
    order_type,
    COALESCE(ECOMM, 0) AS ECOMM_INV,
    COALESCE(RETAIL, 0) AS RETAIL_INV,
    COALESCE(STRAT, 0) AS STRAT_INV,
    COALESCE(B_GRADE, 0) AS B_GRADE_INV,
    COALESCE(COMMUNITY, 0) AS COMMUNITY_INV,
    COALESCE(ECOMM, 0) + COALESCE(RETAIL, 0) + COALESCE(STRAT, 0) + COALESCE(B_GRADE, 0) + COALESCE(COMMUNITY, 0) AS Total_Orders
FROM (
    SELECT 
        CASE 
            WHEN o.do_status = 110 THEN 'Released'
            WHEN o.do_status = 120 THEN 'PDCA'
            WHEN o.do_status = 100 THEN 'DRAFT'
            ELSE NULL
        END AS do_status,
        oli.invn_type,
        CASE 
            WHEN o.order_type = 'INTERCOMPANY' AND o.mark_for LIKE '%STRAGGLER%' THEN 'INTERCOMPANY - STRAGGLER'
            WHEN o.order_type = 'DCTRANSFER' AND o.mark_for LIKE '%STRAGGLER%' THEN 'DCTRANSFER - STRAGGLER'
            WHEN o.order_type = 'SPECIAL' AND o.mark_for LIKE '%STRAGGLER%' THEN 'SPECIAL - STRAGGLER'
            WHEN o.order_type = 'ALLOC' AND o.mark_for LIKE '%NSO%' THEN 'ALLOC - NSO'
            WHEN o.order_type = 'SPECIAL' AND o.mark_for LIKE '%NSO%' THEN 'SPECIAL - NSO'
            ELSE o.order_type
        END AS order_type,
        COUNT(DISTINCT o.tc_order_id) AS num_orders
    FROM 
        WM.orders o 
        JOIN WM.order_line_item oli ON o.order_id = oli.order_id
        JOIN WM.item_facility_mapping_wms ifm ON ifm.item_id = oli.item_id
        JOIN WM.do_status ds ON ds.order_status = o.do_status
        JOIN WM.item_cbo ic ON oli.item_name = ic.item_name 
        JOIN WM.wm_inventory wmi ON oli.item_id = wmi.ITEM_ID AND oli.invn_type = wmi.inventory_type
        JOIN WM.locn_hdr lh ON wmi.LOCATION_ID = lh.LOCN_ID
        JOIN WM.item_master im ON ic.item_id = im.item_id
        LEFT JOIN WM.facility f ON o.d_facility_id = f.facility_id
    WHERE 
        o.do_status IN ('110','120')
        AND o.is_original_order = '1'
    GROUP BY
        CASE 
            WHEN o.do_status = 110 THEN 'Released'
            WHEN o.do_status = 120 THEN 'PDCA'
            WHEN o.do_status = 100 THEN 'DRAFT'
            ELSE NULL
        END,
     oli.invn_type,
     CASE 
        WHEN o.order_type = 'INTERCOMPANY' AND o.mark_for LIKE '%STRAGGLER%' THEN 'INTERCOMPANY - STRAGGLER'
        WHEN o.order_type = 'DCTRANSFER' AND o.mark_for LIKE '%STRAGGLER%' THEN 'DCTRANSFER - STRAGGLER'
        WHEN o.order_type = 'SPECIAL' AND o.mark_for LIKE '%STRAGGLER%' THEN 'SPECIAL - STRAGGLER'
        WHEN o.order_type = 'ALLOC' AND o.mark_for LIKE '%NSO%' THEN 'ALLOC - NSO'
        WHEN o.order_type = 'SPECIAL' AND o.mark_for LIKE '%NSO%' THEN 'SPECIAL - NSO'
        ELSE o.order_type
     END
) 
PIVOT (
    SUM(num_orders) 
    FOR invn_type IN (
        'E' AS ECOMM, 
        'R' AS RETAIL, 
        'S' AS STRAT, 
        'B' AS B_GRADE, 
        'C' AS COMMUNITY
    )
) 
ORDER BY 
    do_status DESC,
    CASE 
        WHEN order_type = 'ECOMM' THEN 1
        WHEN order_type = 'RETAIL' THEN 2
        WHEN order_type = 'ALLOC' THEN 3
        WHEN order_type = 'ALLOC - NSO' THEN 4
        WHEN order_type = 'SPECIAL' THEN 5
        WHEN order_type = 'SPECIAL - STRAGGLER' THEN 6
        WHEN order_type = 'SPECIAL - NSO' THEN 7
        WHEN order_type = 'DCTRANSFER' THEN 8
        WHEN order_type = 'DCTRANSFER - STRAGGLER' THEN 9
        WHEN order_type = 'INTERCOMPANY' THEN 10
        WHEN order_type = 'INTERCOMPANY - STRAGGLER' THEN 11
        WHEN order_type = 'STRAT' THEN 12
        WHEN order_type = 'REPLEN' THEN 13
        WHEN order_type = 'COMMUNITY' THEN 14
        WHEN order_type = 'WAREHOUSE' THEN 15
        ELSE 16
    END;
