WITH ranked_data AS (
    SELECT 
        ROW_NUMBER() OVER (PARTITION BY cntr_nbr ORDER BY create_date_time DESC) AS row_num,
        cntr_nbr,
        create_date_time + INTERVAL '3' HOUR AS create_date_time,
        menu_optn_name
    FROM wm.prod_trkg_tran
),
oLPN_age AS (
    SELECT 
        cntr_nbr,
        create_date_time,
        menu_optn_name
    FROM ranked_data
    WHERE row_num = 1
),
CTE AS (
    SELECT 
        Building.Facility,
        CASE 
            WHEN TRUNC(wm.orders.created_dttm + INTERVAL '3' HOUR) = TRUNC(SYSDATE + INTERVAL '3' HOUR)               THEN 'Same Day'
            WHEN TRUNC(wm.orders.created_dttm + INTERVAL '3' HOUR) = TRUNC((SYSDATE + INTERVAL '3' HOUR) - 1)         THEN '1 Day old'
            WHEN TRUNC(wm.orders.created_dttm + INTERVAL '3' HOUR) = TRUNC((SYSDATE + INTERVAL '3' HOUR) - 2)         THEN '2 Days old'
            WHEN TRUNC(wm.orders.created_dttm + INTERVAL '3' HOUR) = TRUNC((SYSDATE + INTERVAL '3' HOUR) - 3)         THEN '3 Days old'
            WHEN TRUNC(wm.orders.created_dttm + INTERVAL '3' HOUR) = TRUNC((SYSDATE + INTERVAL '3' HOUR) - 4)         THEN '4 Days old'
            WHEN TRUNC(wm.orders.created_dttm + INTERVAL '3' HOUR) = TRUNC((SYSDATE + INTERVAL '3' HOUR) - 5)         THEN '5 Days old'
            WHEN TRUNC(wm.orders.created_dttm + INTERVAL '3' HOUR) = TRUNC((SYSDATE + INTERVAL '3' HOUR) - 6)         THEN '6 Days old'
            WHEN TRUNC(wm.orders.created_dttm + INTERVAL '3' HOUR) = TRUNC((SYSDATE + INTERVAL '3' HOUR) - 7)         THEN '7 Days old'
            WHEN TRUNC(wm.orders.created_dttm + INTERVAL '3' HOUR) = TRUNC((SYSDATE + INTERVAL '3' HOUR) - 8)         THEN '8 Days old'
            WHEN TRUNC(wm.orders.created_dttm + INTERVAL '3' HOUR) = TRUNC((SYSDATE + INTERVAL '3' HOUR) - 9)         THEN '9 Days old'
            WHEN TRUNC(wm.orders.created_dttm + INTERVAL '3' HOUR) = TRUNC((SYSDATE + INTERVAL '3' HOUR) - 10)        THEN '10 Days old'
        END AS Date_Difference,
        TO_CHAR(wm.orders.created_dttm + INTERVAL '3' HOUR, 'YYYY/MM/DD') AS Order_Create_Date_EST,
        wm.orders.tc_order_id,
        CASE
            WHEN UPPER(wm.orders.D_country_code) = 'CA' THEN 'Domestic'
            ELSE 'Cross-Border'
        END AS Order_Country,
        wm.orders.do_status || ' - ' || wm.do_status.description AS Order_Status,
        wm.orders.total_nbr_of_units AS DO_Quantity,
        wm.lpn.total_LPN_QTY AS oLPN_Quantity,
        CASE 
            WHEN SUM(wm.lpn.total_LPN_QTY) OVER (PARTITION BY wm.orders.tc_order_id)
                 = wm.orders.total_nbr_of_units
            THEN 'Good'
            WHEN psi.sku_list IS NULL
            THEN 'Good'
            ELSE 'Bad'
        END AS Invoice,
        psi.SKU_List,
        lpn_facility_status.description AS oLPN_Status,
        CASE
            WHEN COUNT(
                    CASE 
                        WHEN current_locn_lpn.dsp_locn LIKE 'HS%' 
                          OR current_locn_lpn.dsp_locn LIKE 'HM%' 
                          OR current_locn_lpn.dsp_locn = 'SH-P -L-26' 
                          OR current_locn_lpn.dsp_locn = 'SHP-S2-28' 
                        THEN 1 
                    END
                 ) OVER (PARTITION BY wm.orders.tc_order_id) > 0 
            THEN 'Yes'
            ELSE 'No'
        END AS Hospital_Flag,
        current_locn_lpn.dsp_locn,
        wm.lpn.tc_lpn_id,
        wm.lpn.ship_via,
        wm.ship_via.description AS Ship_Via_Description,
        wm.lpn.TRACKING_NBR,
        wm.lpn.TC_parent_LPN_id AS Pallet_ID,
        wm.lpn.TC_shipment_id AS Shipment_ID,
        CASE 
            WHEN wm.shipment.shipment_closed_indicator = 0 THEN 'Open' 
            WHEN wm.shipment.shipment_closed_indicator = 1 THEN 'Closed'
            ELSE NULL 
        END AS Shipment_Status,
        wm.shipment.TRAILER_NUMBER,
        FLOOR(
            EXTRACT(DAY FROM (CAST(SYSDATE + INTERVAL '3' HOUR AS TIMESTAMP) - CAST(oLPN_age.create_date_time AS TIMESTAMP))) * 24 +
            EXTRACT(HOUR FROM (CAST(SYSDATE + INTERVAL '3' HOUR AS TIMESTAMP) - CAST(oLPN_age.create_date_time AS TIMESTAMP))) +
            EXTRACT(MINUTE FROM (CAST(SYSDATE + INTERVAL '3' HOUR AS TIMESTAMP) - CAST(oLPN_age.create_date_time AS TIMESTAMP))) / 60
        ) AS Age_in_Hours,
        oLPN_age.create_date_time AS Last_Updated_DTTM,
        oLPN_age.menu_optn_name AS Last_Transaction_Name
    FROM wm.orders
    LEFT JOIN wm.do_status 
        ON wm.orders.do_status = wm.do_status.order_status
    LEFT JOIN wm.lpn 
        ON wm.lpn.tc_order_id = wm.orders.tc_order_id  
       AND wm.lpn.inbound_outbound_indicator = 'O'
    LEFT JOIN wm.locn_hdr current_locn_lpn 
        ON wm.lpn.curr_sub_locn_id = current_locn_lpn.locn_id 
    LEFT JOIN wm.lpn_facility_status 
        ON wm.lpn.lpn_facility_status = wm.lpn_facility_status.lpn_facility_status 
       AND wm.lpn_facility_status.inbound_outbound_indicator = 'O'
    LEFT JOIN (
        SELECT 
            task_cmpl_ref_nbr,
            CASE 
                WHEN COUNT(DISTINCT Facility) > 1 THEN 'Cross Building - PNP'
                ELSE MAX(Facility)
            END AS Facility
        FROM (
            SELECT DISTINCT 
                wm.alloc_invn_dtl.task_cmpl_ref_nbr,
                CASE 
                    WHEN wm.alloc_invn_dtl.invn_type = 'R' AND wm.locn_lpn.work_grp = 'GIFT' THEN 'Milton'
                    WHEN wm.alloc_invn_dtl.invn_type = 'E' AND wm.locn_lpn.work_grp = 'GIFT' THEN 'Mississauga'
                    WHEN wm.locn_lpn.work_grp = 'SHLF' THEN 'Mississauga'
                    WHEN wm.locn_lpn.work_grp IN ('MFLW', 'MRPH', 'MACT', 'MRAK') THEN 'Milton'
                    ELSE wm.locn_lpn.work_grp
                END AS Facility
            FROM wm.alloc_invn_dtl 
            LEFT JOIN wm.locn_hdr locn_lpn 
                ON wm.alloc_invn_dtl.pull_locn_id = locn_lpn.locn_id 
            WHERE task_genrtn_ref_code = '1'
        )
        GROUP BY task_cmpl_ref_nbr
    ) Building 
        ON Building.task_cmpl_ref_nbr = wm.lpn.tc_lpn_id
    LEFT JOIN oLPN_age 
        ON oLPN_age.cntr_nbr = wm.lpn.tc_lpn_id
    LEFT JOIN wm.ship_via 
        ON wm.ship_via.ship_via = wm.lpn.ship_via
    LEFT JOIN wm.shipment 
        ON wm.shipment.tc_shipment_id = wm.lpn.tc_shipment_id
    LEFT JOIN (
        SELECT
            psi.tc_order_id,
            RTRIM(
                XMLCAST(
                    XMLAGG(
                        XMLELEMENT(e, ic.item_name || ', ')
                        ORDER BY ic.item_name
                    ) AS CLOB
                ),
                ', '
            ) AS sku_list
        FROM wm.picking_short_item psi
        LEFT JOIN wm.item_cbo ic 
            ON ic.item_id = psi.item_id
        WHERE psi.stat_code = '0'
        GROUP BY psi.tc_order_id
    ) psi 
        ON psi.tc_order_id = wm.orders.tc_order_id
    WHERE wm.orders.order_type = 'ECOMM'
      AND wm.do_status.order_status IN ('160', '165','180')
      AND wm.lpn.lpn_facility_status != '99'
),

Age_Calc AS (
    SELECT
        CTE.*,

        COALESCE(
            MIN(CASE WHEN CTE.Pallet_ID IS NULL THEN CTE.Age_in_Hours END)
                OVER (PARTITION BY CTE.tc_order_id),
            MIN(CTE.Age_in_Hours)
                OVER (PARTITION BY CTE.tc_order_id)
        ) AS Chosen_Min_Age
    FROM CTE
),

Age_Bucket AS (
    SELECT
        Age_Calc.*,
        CASE
            WHEN Age_Calc.Chosen_Min_Age > 95 THEN 'More than 96'
            WHEN Age_Calc.Chosen_Min_Age > 71 THEN 'More than 72'
            WHEN Age_Calc.Chosen_Min_Age > 47 THEN 'More than 48'
            WHEN Age_Calc.Chosen_Min_Age > 35 THEN 'More than 36'
            WHEN Age_Calc.Chosen_Min_Age > 23 THEN 'More than 24'
            ELSE 'Less than 24'
        END AS Age_Category
    FROM Age_Calc
),

Final_Output AS (
    SELECT
        CASE 
            WHEN COUNT(DISTINCT Age_Bucket.Facility)
                 OVER (PARTITION BY Age_Bucket.tc_order_id) > 1
            THEN 'Cross Building'
            ELSE MAX(Age_Bucket.Facility)
                 OVER (PARTITION BY Age_Bucket.tc_order_id)
        END AS Facility,

        Age_Bucket.Date_Difference AS Order_Age,
        Age_Bucket.Order_Create_Date_EST,
        Age_Bucket.tc_order_id,
        Age_Bucket.Order_Country AS Destination,
        Age_Bucket.Order_Status,
        Age_Bucket.Invoice,
        Age_Bucket.SKU_List AS Pending_Chase_SKUs,
        Age_Bucket.DO_Quantity,
        Age_Bucket.oLPN_Quantity,
        Age_Bucket.oLPN_Status,
        Age_Bucket.Hospital_Flag,
        Age_Bucket.dsp_locn AS Current_location,
        Age_Bucket.tc_lpn_id AS oLPN,
        CASE
            WHEN COUNT(DISTINCT Age_Bucket.tc_lpn_id) OVER (PARTITION BY Age_Bucket.tc_order_id) > 1 
            THEN 'Split Order'
            ELSE 'No Splits'
        END AS Split_Order_Check,
        Age_Bucket.ship_via,
        Age_Bucket.Ship_Via_Description,
        Age_Bucket.TRACKING_NBR AS Tracking_Number,
        Age_Bucket.Pallet_ID,
        CASE
            WHEN SUM(CASE WHEN Age_Bucket.TRACKING_NBR IS NULL THEN 1 ELSE 0 END)
                 OVER (PARTITION BY Age_Bucket.tc_order_id) > 0
            THEN 'Invalid'

            WHEN ( SUM(CASE WHEN Age_Bucket.Pallet_ID IS NOT NULL THEN 1 ELSE 0 END)
                   OVER (PARTITION BY Age_Bucket.tc_order_id) > 0 )
             AND ( SUM(CASE WHEN Age_Bucket.Pallet_ID IS NULL THEN 1 ELSE 0 END)
                   OVER (PARTITION BY Age_Bucket.tc_order_id) > 0 )
            THEN 'Investigate'

            WHEN SUM(CASE WHEN Age_Bucket.Pallet_ID IS NOT NULL THEN 1 ELSE 0 END)
                 OVER (PARTITION BY Age_Bucket.tc_order_id) > 0
            THEN 'On Pallet'

            ELSE 'No Update'
        END AS Investigation,
        Age_Bucket.Shipment_ID,
        Age_Bucket.Shipment_Status,
        Age_Bucket.TRAILER_NUMBER,
        Age_Bucket.Age_in_Hours AS oLPN_Age,
        Age_Bucket.Age_Category,
        Age_Bucket.Last_Updated_DTTM,
        Age_Bucket.Last_Transaction_Name
    FROM Age_Bucket
    WHERE Age_Bucket.Invoice != 'Bad'
)

SELECT *
FROM final_output
WHERE 1=1
  AND Order_Create_Date_EST IN ('2025/12/26','2025/12/27','2025/12/28','2025/12/29','2025/12/30')
  AND final_output.Investigation != 'On Pallet'
  AND final_output.Investigation != 'Invalid'
  AND final_output.facility != 'Milton'
ORDER BY Order_Create_Date_EST, tc_order_id;
