WITH filtered_orders AS (
    SELECT
        wm.orders.tc_order_id,
        wm.orders.created_dttm,
        wm.order_line_item.invn_type,
        wm.order_line_item.order_qty,
        wm.do_status.order_status,
        wm.item_cbo.item_style,
        wm.item_cbo.PRODUCT_CLASS_ID,
        wm.item_facility_mapping_wms.pick_locn_assign_type,
        wm.item_facility_mapping_wms.item_id,
        wm.order_line_item.item_name
    FROM
        wm.orders
        LEFT JOIN wm.order_line_item ON wm.orders.order_id = wm.order_line_item.order_id
        LEFT JOIN wm.do_status ON wm.orders.do_status = wm.do_status.order_status
        LEFT JOIN WM.item_cbo ON wm.order_line_item.item_name = WM.item_cbo.item_name
        LEFT JOIN WM.item_facility_mapping_wms ON wm.order_line_item.item_id = WM.item_facility_mapping_wms.item_id
    WHERE
        wm.orders.order_type = 'ECOMM'
        AND wm.do_status.order_status < 191
        AND wm.order_line_item.DO_DTL_STATUS NOT IN ('200')
)
SELECT
    CASE 
        WHEN fo.invn_type = 'R' THEN 'Milton'
        WHEN fo.invn_type = 'E' 
            AND (fo.item_style LIKE 'LM%' 
            OR fo.pick_locn_assign_type IN ('P09','P06','PRK') 
            OR fo.PRODUCT_CLASS_ID = '172')
        THEN 'Milton'
        ELSE 'Mississauga'
    END AS facility,
    TO_CHAR(fo.created_dttm + INTERVAL '3' HOUR, 'YYYY/MM/DD') AS Order_Create_Date_EST,
    fo.invn_type AS Order_Line_Inv_Type,
    COUNT(DISTINCT fo.tc_order_id) AS Total_orders,
    SUM(fo.order_qty) AS Total_Units,
    CASE 
        WHEN fo.pick_locn_assign_type = 'P09' THEN 'Footwear'
        ELSE 'Non Footwear'
    END AS Footwear_Indicator
FROM
    filtered_orders fo
WHERE
    fo.order_status < 181
GROUP BY
    CASE 
        WHEN fo.invn_type = 'R' THEN 'Milton'
        WHEN fo.invn_type = 'E' 
            AND (fo.item_style LIKE 'LM%' 
            OR fo.pick_locn_assign_type IN ('P09','P06','PRK') 
            OR fo.PRODUCT_CLASS_ID = '172')
        THEN 'Milton'
        ELSE 'Mississauga'
    END,
    fo.invn_type,
    TO_CHAR(fo.created_dttm + INTERVAL '3' HOUR, 'YYYY/MM/DD'),
    CASE 
        WHEN fo.pick_locn_assign_type = 'P09' THEN 'Footwear'
        ELSE 'Non Footwear'
    END
ORDER BY
    Order_Create_Date_EST,
    fo.invn_type;
